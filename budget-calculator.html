<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly Budget Calculator - Ryan's Financial Calculators</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .print\\:hidden { display: none !important; }
      .print\\:shadow-none { box-shadow: none !important; }
      body { background: white !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function BudgetCalculator() {
      const [darkMode, setDarkMode] = useState(false);
      const [income, setIncome] = useState({
        takehome: '',
        sideIncome: '',
        other: ''
      });

      const [expenses, setExpenses] = useState({
        housing: '',
        utilities: '',
        transportation: '',
        groceries: '',
        debtPayments: '',
        insurance: '',
        savings: '',
        childcare: ''
      });

      const [customCategories, setCustomCategories] = useState([]);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [showAddCategory, setShowAddCategory] = useState(false);
      const [lastSaved, setLastSaved] = useState(null);
      const [saveStatus, setSaveStatus] = useState('');

      // Storage API wrapper for compatibility
      const storage = {
        async get(key) {
          try {
            if (window.storage) {
              return await window.storage.get(key);
            } else {
              const value = localStorage.getItem(key);
              return value ? { key, value } : null;
            }
          } catch (error) {
            const value = localStorage.getItem(key);
            return value ? { key, value } : null;
          }
        },
        async set(key, value) {
          try {
            if (window.storage) {
              return await window.storage.set(key, value);
            } else {
              localStorage.setItem(key, value);
              return { key, value };
            }
          } catch (error) {
            localStorage.setItem(key, value);
            return { key, value };
          }
        },
        async delete(key) {
          try {
            if (window.storage) {
              return await window.storage.delete(key);
            } else {
              localStorage.removeItem(key);
              return { key, deleted: true };
            }
          } catch (error) {
            localStorage.removeItem(key);
            return { key, deleted: true };
          }
        }
      };

      // Load saved data on mount
      useEffect(() => {
        loadBudget();
      }, []);

      // Auto-save whenever data changes
      useEffect(() => {
        const timeoutId = setTimeout(() => {
          saveBudget();
        }, 1000);

        return () => clearTimeout(timeoutId);
      }, [income, expenses, customCategories, darkMode]);

      const saveBudget = async () => {
        try {
          const budgetData = {
            income,
            expenses,
            customCategories,
            darkMode,
            timestamp: new Date().toISOString()
          };
          
          await storage.set('budget-data', JSON.stringify(budgetData));
          setLastSaved(new Date());
          setSaveStatus('saved');
          setTimeout(() => setSaveStatus(''), 2000);
        } catch (error) {
          console.error('Failed to save budget:', error);
          setSaveStatus('error');
        }
      };

      const loadBudget = async () => {
        try {
          const result = await storage.get('budget-data');
          if (result && result.value) {
            const budgetData = JSON.parse(result.value);
            setIncome(budgetData.income || { takehome: '', sideIncome: '', other: '' });
            setExpenses(budgetData.expenses || {
              housing: '',
              utilities: '',
              transportation: '',
              groceries: '',
              debtPayments: '',
              insurance: '',
              savings: '',
              childcare: ''
            });
            setCustomCategories(budgetData.customCategories || []);
            setDarkMode(budgetData.darkMode || false);
            setLastSaved(new Date(budgetData.timestamp));
          }
        } catch (error) {
          console.log('No saved budget found or error loading:', error);
        }
      };

      const resetBudget = async () => {
        if (confirm('Are you sure you want to reset your budget? This will clear all data.')) {
          setIncome({ takehome: '', sideIncome: '', other: '' });
          setExpenses({
            housing: '',
            utilities: '',
            transportation: '',
            groceries: '',
            debtPayments: '',
            insurance: '',
            savings: '',
            childcare: ''
          });
          setCustomCategories([]);
          try {
            await storage.delete('budget-data');
            setLastSaved(null);
          } catch (error) {
            console.error('Failed to delete budget:', error);
          }
        }
      };

      const exportToPrint = () => {
        window.print();
      };

      const calculateTotal = (obj) => {
        return Object.values(obj).reduce((sum, val) => {
          const num = parseFloat(val) || 0;
          return sum + num;
        }, 0);
      };

      const totalIncome = calculateTotal(income);
      const totalExpenses = calculateTotal(expenses) + calculateTotal(
        customCategories.reduce((acc, cat) => ({ ...acc, [cat.id]: cat.amount }), {})
      );
      const leftover = totalIncome - totalExpenses;
      const leftoverPercentage = totalIncome > 0 ? ((leftover / totalIncome) * 100).toFixed(1) : 0;

      const handleIncomeChange = (field, value) => {
        setIncome({ ...income, [field]: value });
      };

      const handleExpenseChange = (field, value) => {
        setExpenses({ ...expenses, [field]: value });
      };

      const handleCustomCategoryChange = (id, value) => {
        setCustomCategories(customCategories.map(cat =>
          cat.id === id ? { ...cat, amount: value } : cat
        ));
      };

      const addCustomCategory = () => {
        if (newCategoryName.trim()) {
          setCustomCategories([...customCategories, {
            id: Date.now(),
            name: newCategoryName.trim(),
            amount: ''
          }]);
          setNewCategoryName('');
          setShowAddCategory(false);
        }
      };

      const removeCustomCategory = (id) => {
        setCustomCategories(customCategories.filter(cat => cat.id !== id));
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-CA', {
          style: 'currency',
          currency: 'CAD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(amount);
      };

      const formatTimestamp = (date) => {
        if (!date) return '';
        return new Intl.DateTimeFormat('en-CA', {
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        }).format(date);
      };

      const bgClass = darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-indigo-50';
      const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
      const textPrimary = darkMode ? 'text-gray-100' : 'text-gray-800';
      const textSecondary = darkMode ? 'text-gray-300' : 'text-gray-600';
      const inputBg = darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-white border-gray-300 text-gray-900';
      const labelText = darkMode ? 'text-gray-300' : 'text-gray-700';

      return (
        <div className={`min-h-screen ${bgClass} p-4 md:p-8 transition-colors duration-300`}>
          <div className="max-w-4xl mx-auto">
            {/* Back to Home Button */}
            <div className="mb-4 print:hidden">
              <a 
                href="index.html" 
                className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                  darkMode 
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' 
                    : 'bg-white text-gray-700 hover:bg-gray-100'
                } shadow-md`}
              >
                <span>‚Üê</span> Back to Home
              </a>
            </div>

            <div className={`${cardBg} rounded-2xl shadow-xl p-6 md:p-8 transition-colors duration-300 print:shadow-none`}>
              {/* Header with controls */}
              <div className="flex justify-between items-start mb-6 print:mb-4">
                <div>
                  <h1 className={`text-3xl md:text-4xl font-bold ${textPrimary} mb-2`}>Monthly Budget Calculator</h1>
                  <p className={`${textSecondary} mb-2`}>Discover how much you have left after covering your essentials</p>
                  {lastSaved && (
                    <p className={`text-xs ${textSecondary} flex items-center gap-2`}>
                      {saveStatus === 'saved' && <span className="text-green-500">‚úì Saved</span>}
                      Last saved: {formatTimestamp(lastSaved)}
                    </p>
                  )}
                </div>
                <div className="flex gap-2 print:hidden">
                  <button
                    onClick={() => setDarkMode(!darkMode)}
                    className={`p-2 rounded-lg transition ${darkMode ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                    title="Toggle dark mode"
                  >
                    {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                  </button>
                  <button
                    onClick={exportToPrint}
                    className={`p-2 rounded-lg transition ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                    title="Print budget"
                  >
                    üìÑ
                  </button>
                  <button
                    onClick={resetBudget}
                    className={`p-2 rounded-lg transition ${darkMode ? 'bg-gray-700 text-red-400 hover:bg-gray-600' : 'bg-gray-100 text-red-600 hover:bg-gray-200'}`}
                    title="Reset budget"
                  >
                    üîÑ
                  </button>
                </div>
              </div>

              {/* Income Section */}
              <div className="mb-8">
                <h2 className={`text-2xl font-semibold ${textPrimary} mb-4 flex items-center`}>
                  <span className="bg-green-100 text-green-700 rounded-lg px-3 py-1 mr-3">Income</span>
                </h2>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Take-Home Pay</label>
                    <input
                      type="number"
                      value={income.takehome}
                      onChange={(e) => handleIncomeChange('takehome', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Side Income</label>
                    <input
                      type="number"
                      value={income.sideIncome}
                      onChange={(e) => handleIncomeChange('sideIncome', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Other Income</label>
                    <input
                      type="number"
                      value={income.other}
                      onChange={(e) => handleIncomeChange('other', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                </div>
                <div className={`mt-4 p-4 rounded-lg ${darkMode ? 'bg-green-900/30' : 'bg-green-50'}`}>
                  <p className={`text-lg font-semibold ${darkMode ? 'text-green-400' : 'text-green-800'}`}>
                    Total Monthly Income: {formatCurrency(totalIncome)}
                  </p>
                </div>
              </div>

              {/* Expenses Section */}
              <div className="mb-8">
                <h2 className={`text-2xl font-semibold ${textPrimary} mb-4 flex items-center`}>
                  <span className="bg-red-100 text-red-700 rounded-lg px-3 py-1 mr-3">Essential Expenses</span>
                </h2>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Housing (Rent/Mortgage)</label>
                    <input
                      type="number"
                      value={expenses.housing}
                      onChange={(e) => handleExpenseChange('housing', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Utilities (Power, Water, Internet, Phone)</label>
                    <input
                      type="number"
                      value={expenses.utilities}
                      onChange={(e) => handleExpenseChange('utilities', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Transportation (Car, Gas, Transit)</label>
                    <input
                      type="number"
                      value={expenses.transportation}
                      onChange={(e) => handleExpenseChange('transportation', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Groceries</label>
                    <input
                      type="number"
                      value={expenses.groceries}
                      onChange={(e) => handleExpenseChange('groceries', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Debt Payments (Credit Cards, Loans)</label>
                    <input
                      type="number"
                      value={expenses.debtPayments}
                      onChange={(e) => handleExpenseChange('debtPayments', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Insurance (Health, Life, Home/Tenant)</label>
                    <input
                      type="number"
                      value={expenses.insurance}
                      onChange={(e) => handleExpenseChange('insurance', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Savings Goals</label>
                    <input
                      type="number"
                      value={expenses.savings}
                      onChange={(e) => handleExpenseChange('savings', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${labelText} mb-2`}>Childcare / Education</label>
                    <input
                      type="number"
                      value={expenses.childcare}
                      onChange={(e) => handleExpenseChange('childcare', e.target.value)}
                      placeholder="0"
                      className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                    />
                  </div>
                </div>

                {/* Custom Categories */}
                {customCategories.length > 0 && (
                  <div className="mt-6">
                    <h3 className={`text-lg font-semibold ${labelText} mb-3`}>Additional Categories</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      {customCategories.map((cat) => (
                        <div key={cat.id} className="relative">
                          <label className={`block text-sm font-medium ${labelText} mb-2`}>{cat.name}</label>
                          <div className="flex gap-2">
                            <input
                              type="number"
                              value={cat.amount}
                              onChange={(e) => handleCustomCategoryChange(cat.id, e.target.value)}
                              placeholder="0"
                              className={`flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent ${inputBg}`}
                            />
                            <button
                              onClick={() => removeCustomCategory(cat.id)}
                              className={`px-3 py-2 rounded-lg transition print:hidden ${darkMode ? 'bg-red-900/30 text-red-400 hover:bg-red-900/50' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}
                            >
                              ‚úï
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Add Category Button */}
                <div className="mt-6 print:hidden">
                  {!showAddCategory ? (
                    <button
                      onClick={() => setShowAddCategory(true)}
                      className={`flex items-center gap-2 px-4 py-2 rounded-lg transition font-medium ${darkMode ? 'bg-indigo-900/30 text-indigo-400 hover:bg-indigo-900/50' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}`}
                    >
                      <span>‚ûï</span> Add Custom Category
                    </button>
                  ) : (
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newCategoryName}
                        onChange={(e) => setNewCategoryName(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && addCustomCategory()}
                        placeholder="Category name (e.g., Entertainment, Pets)"
                        className={`flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent ${inputBg}`}
                      />
                      <button
                        onClick={addCustomCategory}
                        className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
                      >
                        Add
                      </button>
                      <button
                        onClick={() => {
                          setShowAddCategory(false);
                          setNewCategoryName('');
                        }}
                        className={`px-4 py-3 rounded-lg transition ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                      >
                        Cancel
                      </button>
                    </div>
                  )}
                </div>

                <div className={`mt-4 p-4 rounded-lg ${darkMode ? 'bg-red-900/30' : 'bg-red-50'}`}>
                  <p className={`text-lg font-semibold ${darkMode ? 'text-red-400' : 'text-red-800'}`}>
                    Total Monthly Expenses: {formatCurrency(totalExpenses)}
                  </p>
                </div>
              </div>

              {/* Results Section */}
              <div className={`p-6 rounded-2xl ${leftover >= 0 ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-rose-600'}`}>
                <h2 className="text-2xl font-bold text-white mb-2">What's Left Over</h2>
                <p className="text-5xl md:text-6xl font-bold text-white mb-2">{formatCurrency(leftover)}</p>
                <p className="text-xl text-white opacity-90">
                  That's {Math.abs(parseFloat(leftoverPercentage))}% of your monthly income
                </p>
                {leftover >= 0 ? (
                  <p className="mt-4 text-white text-lg">
                    Great job! This is your disposable income for discretionary spending, extra savings, or paying down debt faster.
                  </p>
                ) : (
                  <p className="mt-4 text-white text-lg">
                    You're spending more than you earn. Look for areas to reduce expenses or ways to increase your income.
                  </p>
                )}
              </div>

              <div className={`mt-6 p-4 rounded-lg ${darkMode ? 'bg-blue-900/30' : 'bg-blue-50'}`}>
                <p className={`text-sm ${darkMode ? 'text-blue-300' : 'text-gray-700'}`}>
                  <strong>Tip:</strong> Your budget is automatically saved as you make changes. As you get comfortable with budgeting, add custom categories to track specific expenses like entertainment, dining out, or hobbies. This helps you understand exactly where your money goes!
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<BudgetCalculator />, document.getElementById('root'));
  </script>
</body>
</html>